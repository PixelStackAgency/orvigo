# Razorpay Setup Helper

This guide helps you set up Razorpay payment integration for Orvigo.

## Quick Start

### 1. Create Razorpay Account

- Sign up at https://razorpay.com
- Email verification and KYC (if required)
- You'll get instant test keys

### 2. Get Test Keys

1. Log in to Razorpay Dashboard: https://dashboard.razorpay.com
2. Go to **Settings** → **API Keys**
3. You'll see **Key ID** and **Key Secret** in **Test Mode** section
4. Copy both keys (you'll need them in a moment)

### 3. Add Keys to GitHub Secrets (for CI/CD)

Run this in PowerShell from the project root:

```powershell
$key_id = Read-Host "Enter Razorpay Test Key ID"
$key_secret = Read-Host "Enter Razorpay Test Key Secret"

gh secret set RAZORPAY_KEY_ID --repo PixelStackAgency/orvigo --body $key_id
gh secret set RAZORPAY_KEY_SECRET --repo PixelStackAgency/orvigo --body $key_secret

Write-Host "Secrets set successfully. Commit and push to trigger Render redeploy."
```

### 4. Create Razorpay Webhook

1. In Razorpay Dashboard, go to **Settings** → **Webhooks**
2. Click **Add New Webhook**
3. **Webhook URL**: `https://orvigo-api.onrender.com/api/payment-webhook.php` (replace with your Render URL)
4. **Events to Subscribe**: Select all (or at minimum: `payment.authorized`, `payment.failed`, `payment.completed`)
5. Copy the **Webhook Secret** generated by Razorpay
6. Add to your Render environment as `RAZORPAY_WEBHOOK_SECRET`

### 5. Test in Sandbox Mode

1. Deploy to Render with keys set
2. Visit your Render URL's booking page
3. Fill the booking form and proceed to payment
4. Use Razorpay test card: **4111 1111 1111 1111**
   - Expiry: Any future date (e.g., 12/25)
   - CVV: Any 3 digits (e.g., 123)
   - OTP: 123456 (or any 6 digits)
5. Payment should succeed
6. Check Razorpay Dashboard → **Transactions** to see the payment
7. Check Render logs to see webhook callback

### 6. Switch to Live Keys (Production)

When ready for production:

1. In Razorpay Dashboard, switch to **Live Mode**
2. Get live keys (you'll need to complete payment setup, bank details, etc.)
3. Replace test keys with live keys in Render environment
4. Create a new webhook with live mode (same process)
5. Update `RAZORPAY_WEBHOOK_SECRET` with live webhook secret
6. Redeploy on Render

## Test Cards

### Razorpay Test Cards

| Scenario | Card Number | Expiry | CVV | OTP |
|---|---|---|---|---|
| Success | 4111 1111 1111 1111 | Any future | Any 3 digits | 123456 |
| Failure | 4000 0000 0000 0002 | Any future | Any 3 digits | 123456 |
| 3D Secure | 4111 1111 1111 1111 | Any future | Any 3 digits | 123456 |

## Webhook Integration

The webhook endpoint `/api/payment-webhook.php` receives payment status updates from Razorpay:

1. **Verifies webhook signature** using `RAZORPAY_WEBHOOK_SECRET`
2. **Updates booking payment status** in `storage/bookings.json`
3. **Triggers notifications** (email/SMS) on successful payment
4. **Logs all events** to `logs/notifications.log`

Example webhook payload:

```json
{
  "event": "payment.authorized",
  "payload": {
    "payment": {
      "entity": {
        "id": "pay_XXXXXXXXXXXXXXXX",
        "order_id": "order_XXXXXXXXXXXXXXXX",
        "amount": 10000,
        "currency": "INR",
        "status": "authorized"
      }
    }
  },
  "signature": "webhook_signature_xxx"
}
```

## Troubleshooting

| Issue | Solution |
|---|---|
| Payment form not appearing | Check `RAZORPAY_KEY_ID` is set in Render |
| "Invalid Key" error | Verify key ID/secret are correct test keys |
| Webhook not triggering | Verify webhook URL in Razorpay matches Render URL |
| Payment status not updating | Check `RAZORPAY_WEBHOOK_SECRET` and logs |
| Test payment fails | Verify test card number and OTP (123456) |

## Support

- Razorpay Docs: https://razorpay.com/docs/
- Test integration: https://razorpay.com/docs/payments/payments-gateway/test-integration/
- Webhook docs: https://razorpay.com/docs/webhooks/
